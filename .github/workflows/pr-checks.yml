name: Pull Request Checks

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  quick-check:
    name: Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Generate Gradle Wrapper
        run: gradle wrapper --gradle-version 8.13

      - name: Make gradlew executable
        run: chmod +x gradlew


      - name: Check build.gradle.kts syntax
        run: ./gradlew help --no-daemon

      - name: Compile project
        run: ./gradlew compileDebugKotlin --no-daemon

      - name: Run quick tests
        run: ./gradlew testDebugUnitTest --no-daemon --max-workers=2

      - name: Comment on PR
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.pull_request.number;
            const status = '${{ job.status }}' === 'success' ? '‚úÖ PASSED' : '‚ùå FAILED';
            
            github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: `## PR Quick Check ${status}\n\n**Build:** ${status}\n**Tests:** ${status}\n\nFull CI/CD pipeline running...`
            });

  size-check:
    name: APK Size Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Generate Gradle Wrapper
        run: gradle wrapper --gradle-version 8.13

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build debug APK
        run: ./gradlew assembleDebug --no-daemon

      - name: Check APK size
        run: |
          APK_SIZE=$(stat -c%s "app/build/outputs/apk/debug/app-debug.apk")
          APK_SIZE_MB=$((APK_SIZE / 1024 / 1024))
          echo "APK Size: ${APK_SIZE_MB} MB"
          
          if [ $APK_SIZE_MB -gt 50 ]; then
            echo "‚ö†Ô∏è Warning: APK size is larger than 50 MB"
          fi
          
          echo "apk_size_mb=$APK_SIZE_MB" >> $GITHUB_ENV

      - name: Comment APK size on PR
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const pr_number = context.payload.pull_request.number;
            const size = process.env.apk_size_mb;
            
            github.rest.issues.createComment({
              owner,
              repo,
              issue_number: pr_number,
              body: `## üì¶ APK Size Report\n\n**Debug APK:** ${size} MB\n\n${size > 50 ? '‚ö†Ô∏è APK size exceeds 50 MB' : '‚úÖ APK size is acceptable'}`
            });
